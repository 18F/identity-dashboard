<%= page_heading 'Users' %>

<section aria-label="Search component" class="margin-bottom-4">
  <%= form_with url: users_path,
            method: :get,
            class: "usa-search",
            role: "search",
            data: { turbo: false } do |form| %>
    <%= form.label :query, 'Search users by email', class: 'usa-sr-only', for: 'search-field' %>
    <%= form.text_field :query,
                        type: 'search',
                        id: 'search-field',
                        class: 'usa-input',
                        placeholder: 'Search by email',
                        value: @query %>
    <button class="usa-button" type="submit">
      <span class="usa-search__submit-text">Search</span>
    </button>
  <% end %>
</section>

<div class="display-flex">
  <% if current_user.logingov_admin? %>
    <%= button_to t('headings.users.new_user'),
      new_user_path,
      method: :get,
      class: 'usa-button'
    %>
  <% end %>

  <% if can_delete_unconfirmed_users?(current_user) %>
    <%= button_to t('forms.buttons.delete_unconfirmed_users'),
      delete_unconfirmed_users_path,
      method: :delete,
      class: 'usa-button' %>
  <% end %>
</div>

<% if @query.present? %>
  <p class="usa-prose margin-bottom-2">
    <%= pluralize(@total_count, 'result') %> for "<%= @query %>"
  </p>
<% end %>

<% if @users.any? %>
  <table class="usa-table">
    <thead>
      <tr>
        <th scope="col">Email</th>
        <th scope="col">Signed in?</th>
        <th scope="col">Role</th>
        <% if current_user.logingov_admin? %>
          <th scope="col">Actions</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td><%= user.email %></td>
          <td><%= image_tag sign_in_icon(user), height: '27', width: '27',
                            title: title(user),
                            alt: alt(user),
                            aria: { hidden: true },
                            style: 'vertical-align:bottom' %>
            <%= caption(user) %>
          </td>
          <td><%= user.primary_role.friendly_name %></td>
          <% if current_user.logingov_admin? %>
            <td>
              <%= button_to 'Delete', user_path(user.id), method: :delete,
                          form_class: 'display-inline',
                          class: 'usa-button usa-button--unstyled usa-link margin-right-1',
                          data: { confirm: t('notices.confirm_delete') } %>
              <span>&nbsp;</span>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>

  <%= render 'components/pagination',
      current_page: @page,
      total_pages: @total_pages,
      path_helper: ->(pg) { users_path(query: @query.presence, page: pg) } %>
<% elsif @query.present? %>
  <div class="usa-alert usa-alert--info usa-alert--slim">
    <div class="usa-alert__body">
      <p class="usa-alert__text">No users found matching "<%= @query %>"</p>
    </div>
  </div>
<% end %>
